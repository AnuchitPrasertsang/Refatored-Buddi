# Copies the web file to a .tgz for upload
#
############################

DEST=/Users/wyatt/Desktop/
WWWDIR="${DEST}www"
HELPDIR="Help"
INCLUDE="${HELPDIR}/inc"
ENGLISH="${HELPDIR}/en"


#Export the SVN source
rm -rf $WWWDIR
svn export www $WWWDIR

rm -rf $HELPDIR/*
cp -R $WWWDIR/* $HELPDIR

#Remove the Languages link, as we're not connected to the Internet anyway
sed -i .bak -e '/.*Languages.*/d' $ENGLISH/inc/header.php

#Replace internal occurrences (in the header) of .php with .html
sed -i .bak  -e 's/.php/.html/' $ENGLISH/inc/header.php

#Remove language_bar and translate
rm $HELPDIR/language_bar.php $HELPDIR/translate.php

for X in `ls $HELPDIR/*/*.php`;
	do
	
	#Replace internal occurrences of .php with .html
	sed -i .bak -e 's/.php/.html/' $X

	#Rename files to be .html, and add header / footer to them.
	INCLUDE=`echo $X | cut -f 1,2 -d /`
	INCLUDE=$INCLUDE/inc
	XNEW=`echo $X | cut -f 1 -d .`
	
	cat $INCLUDE/header.php | sed -e 's/.php/.html/' > $XNEW.html
#	cat $HELPDIR/inc/lang.php | sed -e 's/.php/.html/' >> $XNEW.html
	cat $X | grep -v '<? include ' >> $XNEW.html
	cat $INCLUDE/footer.php | grep -v 'http://sourceforge.net' | sed -e 's/.php/.html/' >> $XNEW.html
done

rm -f $HELPDIR/*/*.php
rm -f $HELPDIR/*/*.bak
rm -rf $HELPDIR/*/inc
rm -rf $HELPDIR/inc
rm -rf $HELPDIR/*/.svn
rm -rf $HELPDIR/*/*/.svn

if [ "$1" != "--local" ]; then
	#Tar the pages
	cd $WWWDIR
	tar -czvf $WWWDIR.tgz *

	#Send the tar and untar it
	scp $WWWDIR.tgz olsonw@shell.sf.net:/home/groups/b/bu/buddi/htdocs
	ssh olsonw@shell.sf.net 'tar -C /home/groups/b/bu/buddi/htdocs -zxvf /home/groups/b/bu/buddi/htdocs/www.tgz'
fi

#Remove Tar file
rm -rf $WWWDIR.tgz
