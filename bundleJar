# Bundles Buddi for distribution.  Yes, I know I should include this
#  in the ant script, but I am a) too lazy and b) using some stuff that I don't
#  know how to do from the ant script (such as FTP uploads).
#
# This script is meant to run on OS X, although it should be able to be
#  modified quite easily to run on Linux.  Windows is right out, unless
#  you use Cygwin.
#
# You need to actually create the Buddi.jar file first.  I use the FatJar
#  plugin for Eclipse, via my ant job, to do this, and it works quite well.
#
# You will need to install ant (for the compilation and FatJar'ing); and
#  launch4j (referenced from this script) to create the .exe.  If you don't care
#  about this, you can just use the FatJar Eclipse plugin for making
#  the jar, and this script to package it.
#
# See the bottom of this script for the actual program; everything else
#  are just functions, which are called from the bottom.
#
############################

function init {
	DEST=/Users/wyatt/Desktop/Buddi
	OSXROOT=$DEST/Buddi_OSX
	OSX=$OSXROOT/Buddi
	GENERICROOT=$DEST/Generic
	GENERIC=$GENERICROOT/Buddi
	WINDOWSROOT=$DEST/Windows
	WINDOWS=$WINDOWSROOT/Buddi
	SOURCE=source
	VERSION=`grep 'String VERSION = ' src/org/homeunix/drummer/Const.java | cut -f 7 -d ' ' | sed -e 's/";//' | sed -e 's/"//'`

	# Ensure that the changelog is updated, if this is a public release.
	if [ "$1" == "--release" ]; then
		grep -q "^$VERSION (" Documents/Changelog.txt
		if [ "$?" != 0 ]; then
			echo "Changelog not updated.  Exiting."
			exit 1
		fi
	fi
	
	rm -rf $DEST
	mkdir -p $DEST
	svn export . $DEST/$SOURCE
}



# Do the compilation and jar'ing.  You can avoid running this function
# if you do it yourself.
function make_jar {
	ant
#	ant jar
#
#	# Run the retroweaver methods to make old jars...
#	java -cp ../ant_tasks/retroweaver/lib/asm-commons-3.0_RC1.jar:../ant_tasks/retroweaver/lib/asm-3.0_RC1.jar:../ant_tasks/retroweaver/lib/asm-util-3.0_RC1.jar:../ant_tasks/retroweaver/release/retroweaver-2.0Beta1.jar net.sourceforge.retroweaver.Weaver -jar Buddi-base.jar Buddi-base-1.4.jar
#	java -cp ../ant_tasks/retroweaver/lib/asm-commons-3.0_RC1.jar:../ant_tasks/retroweaver/lib/asm-3.0_RC1.jar:../ant_tasks/retroweaver/lib/asm-util-3.0_RC1.jar:../ant_tasks/retroweaver/release/retroweaver-2.0Beta1.jar net.sourceforge.retroweaver.Weaver -jar lib/Moss.jar lib/Moss-1.4.jar
#
#	# This runs both fatjar and fatjar-1.4
#	ant fatjar
}





#Create the platform independent directory
function bundle_generic {
	mkdir -p $GENERIC
	cp Buddi.jar $GENERIC
#	cp -R $DEST/$SOURCE/Documents $GENERIC
#	cp -R $DEST/$SOURCE/Licenses $GENERIC

	tar -C $GENERICROOT -czf $DEST/Buddi-$VERSION.tgz Buddi
}




#Create the OSX directory
function bundle_osx {
	mkdir -p $OSXROOT
	mkdir -p $OSX/Buddi.app/Contents/Resources/Java/Languages
	mkdir -p $OSX/Buddi.app/Contents/MacOS

	# Needed to make this a real Mac .app bundle
	cp etc/JavaApplicationStub $OSX/Buddi.app/Contents/MacOS

	# Copy the .plist and .icns files
	cp etc/Info.plist $OSX/Buddi.app/Contents/
	cp images/Buddi.icns $OSX/Buddi.app/Contents/Resources/

	# Copy Buddi and associated files
	cp Buddi.jar $OSX/Buddi.app/Contents/Resources/Java/
	cp lib/libquaqua.jnilib $OSX/Buddi.app/Contents/Resources/Java/
	cp lib/quaqua*.jar $OSX/Buddi.app/Contents/Resources/Java/Quaqua.jar

	# Copy text files
#	cp -R $DEST/$SOURCE/Documents $OSX
#	cp -R $DEST/$SOURCE/Licenses $OSX

	if [ "$VERSION" != "" ]; then
		# Archive the bundles
		sed -i .bak  -e "s/BUDDI_VERSION/$VERSION/" $OSX/Buddi.app/Contents/Info.plist
		rm $OSX/Buddi.app/Contents/Info.plist.bak
	fi

	hdiutil create -format UDZO -srcfolder $OSX -o $DEST/Buddi-${VERSION}.dmg
}



# Change the launch4j config file to use correct version
function bundle_windows {
	TEMP_LAUNCH=temp.xml
	cp etc/launch4j.xml $TEMP_LAUNCH
	if [ "$VERSION" != "" ]; then
		VERSION_NO_LETTERS=`echo $VERSION | sed -e "s/[a-z]//g"`
		sed -i .bak  -e "s/VERSION/${VERSION_NO_LETTERS}.0/" $TEMP_LAUNCH
		sed -i .bak  -e "s/VERSION_LONG/${VERSION_NO_LETTERS}.0/" $TEMP_LAUNCH
	fi

	CURRDIR=`pwd`

	# Make the .exe, with correct version as set in previous lines
	../build_tools/launch4j/launch4j $CURRDIR/$TEMP_LAUNCH
	rm $TEMP_LAUNCH*

	# Create the Windows bundle
	mkdir -p $WINDOWS
	cp Buddi.exe $WINDOWS
#	cp -R $DEST/$SOURCE/Documents $WINDOWS
#	cp -R $DEST/$SOURCE/Licenses $WINDOWS

	cd $WINDOWSROOT
	zip -r $DEST/Buddi-$VERSION.zip Buddi
	cd $CURRDIR
}




# Create the source bundle
function bundle_source {
	tar -C $DEST -czf $DEST/Buddi-$VERSION.src.tgz $SOURCE
}



# Remove the bundle directories and build junk in project directory
function clean {
	rm -rf $DEST/$SOURCE
	rm -rf $WINDOWSROOT
	rm -rf $OSXROOT
	rm -rf $GENERICROOT
	
	rm Buddi.exe
	rm *.jar
}


# Upload the bundles
function upload {
	if [ "$1" == "--release" ]; then
		svn copy https://svn.sourceforge.net/svnroot/buddi/trunk https://svn.sourceforge.net/svnroot/buddi/tags/$VERSION -m "Tagging release $VERSION"

		# Upload release files
		USER=anonymous
		PASS=pass
		ftp -n upload.sf.net << END_OF_FTP
user $USER $PASS
cd /incoming
lcd $DEST
bin
put Buddi-$VERSION.zip
put Buddi-$VERSION.tgz
put Buddi-$VERSION.dmg
put Buddi-$VERSION.src.tgz
bye
END_OF_FTP
		echo Upload Complete
	fi
}





init $*
make_jar $*
bundle_windows $*
bundle_osx $*
bundle_generic $*
bundle_source $*
clean $*
upload $*

