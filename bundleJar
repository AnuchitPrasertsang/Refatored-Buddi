# Copies the jar file to the .app package.
#
############################

DEST=/Users/wyatt/Desktop/Buddi
OSXROOT=$DEST/Buddi_OSX
OSX=$OSXROOT/Buddi
GENERIC=$DEST/Buddi
SOURCE=source

./bundleWeb --local

#Export the SVN source
rm -rf $DEST
mkdir -p $DEST
svn export . $DEST/$SOURCE

#Create the platform independent directory
mkdir -p $GENERIC
cp Buddi.jar $GENERIC
cp -R $DEST/$SOURCE/Languages $GENERIC
cp -R Help $GENERIC
cp -R $DEST/$SOURCE/Documents $GENERIC
cp -R $DEST/$SOURCE/Licenses $GENERIC

#Create the OSX directory
mkdir -p $OSXROOT
cp -R Buddi_OSX_Folder $OSX
#mv $OSXROOT/Buddi_OSX_Folder $OSX
#mv $DEST/$SOURCE/Buddi.app $OSX
cp Buddi.jar $OSX/Buddi.app/Contents/Resources/Java/
cp -R $DEST/$SOURCE/Languages $OSX/Buddi.app/Contents/Resources/Java/
cp -R Help $OSX/Buddi.app/Contents/Resources/Java/
cp -R $DEST/$SOURCE/lib/libquaqua.jnilib $OSX/Buddi.app/Contents/Resources/Java/
cp -R $DEST/$SOURCE/Documents $OSX
cp -R $DEST/$SOURCE/Licenses $OSX

#Tar the source and give to each distro
tar -C $DEST -czvf $DEST/$SOURCE.tgz $SOURCE
#cp -R $DEST/$SOURCE.tgz $GENERIC
#cp -R $DEST/$SOURCE.tgz $OSX

#Remove the src directories
rm -rf $DEST/$SOURCE
#rm $DEST/$SOURCE.tgz

VERSION=`grep VERSION src/org/homeunix/drummer/Const.java | cut -f 7 -d ' ' | sed -e 's/";//' | sed -e 's/"//'`

if [ "$VERSION" != "" ]; then
	#Zip and DMG the bundles
	sed -i .bak  -e "s/BUDDI_VERSION/$VERSION/" $OSX/Buddi.app/Contents/Info.plist
	rm $OSX/Buddi.app/Contents/Info.plist.bak
	cd $DEST
	zip -r Buddi-$VERSION.zip Buddi
	rm -rf $GENERIC
	mkdir $GENERIC
	mv $OSX $GENERIC/Buddi
	hdiutil create -format UDZO -srcfolder $GENERIC -o Buddi-$VERSION.dmg
	rm -rf $OSXROOT
	rm -rf $GENERIC

	mv $DEST/$SOURCE.tgz $DEST/Buddi-$VERSION.src.tgz
fi

open $DEST
